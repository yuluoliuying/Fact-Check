<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>factcheck后台管理系统</title>
    <link rel="stylesheet" href="back/layui/css/layui.css">
    <link rel="stylesheet" href="back/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="back/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="back/DataTables/datatables.min.css">
    <link rel="stylesheet" href="back/fileinput/fileinput.min.css">
    <link rel="stylesheet" href="back/fileinput/theme.min.css">
    <link crossorigin="anonymous" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" rel="stylesheet">
    <!--富文本编辑器wangEditor-->
    <link href="https://cdn.staticfile.org/wangEditor/10.0.13/wangEditor.min.css" rel="stylesheet">
    <link href="https://cdn.staticfile.org/wangEditor/10.0.13/fonts/w-e-icon.woff" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->


    <!-- jQuery -->
    <script src="https://cdn.staticfile.org/jquery/3.3.1/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="https://cdn.staticfile.org/fastclick/1.0.6/fastclick.min.js"></script>
    <script src="https://cdn.staticfile.org/jQuery-slimScroll/1.3.8/jquery.slimscroll.min.js"></script>
    <script src="https://cdn.staticfile.org/layer/2.3/layer.js"></script>
    <script src="https://cdn.staticfile.org/codemirror/5.38.0/codemirror.min.js"></script>
    <script src="https://cdn.staticfile.org/codemirror/5.38.0/addon/display/placeholder.min.js"></script>
    <script src="https://cdn.staticfile.org/codemirror/5.38.0/mode/clike/clike.min.js"></script>
    <script src="https://cdn.staticfile.org/codemirror/5.38.0/mode/sql/sql.min.js"></script>
    <script src="https://cdn.staticfile.org/codemirror/5.38.0/mode/xml/xml.min.js"></script>
    <!--富文本编辑器wangEditor-->
    <script src="https://cdn.staticfile.org/wangEditor/10.0.13/wangEditor.min.js"></script>
    <script src="back/jquery-validation-1.19.1/lib/jquery.js"></script>
    <script src="back/DataTables/datatables.min.js"></script>
    <script src="back/layer/layer.js"></script>
    <script src="back/jquery-validation-1.19.1/dist/jquery.validate.min.js"></script>
    <script src="back/jquery-validation-1.19.1/dist/additional-methods.min.js"></script>
    <script src="back/jquery-validation-1.19.1/dist/localization/messages_zh.min.js"></script>
    <script src="back/jquery-validation-1.19.1/lib/jquery.js"></script>
    <script src="back/DataTables/datatables.min.js"></script>
    <script src="back/layer/layer.js"></script>
    <script src="back/jquery-validation-1.19.1/dist/jquery.validate.min.js"></script>
    <script src="back/jquery-validation-1.19.1/dist/additional-methods.min.js"></script>
    <script src="back/jquery-validation-1.19.1/dist/localization/messages_zh.min.js"></script>
    <script type="text/javascript" src="back/cookie/js.cookie.min.js"></script>
    <script type="text/javascript" src="back/fileinput/fileinput.min.js"></script>
    <script type="text/javascript" src="back/fileinput/zh.js"></script>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div class="layui-header" style="background-color: rgb(205,87,18);">
        <div class="layui-logo" style="color: #FFF; font-size: 20px; width: 160px;">Factcheck</div>
        <!-- 头部区域（可配合layui已有的水平导航） -->
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <div id="datetime">
                    <script>
                        setInterval("document.getElementById('datetime').innerHTML=new Date().toLocaleString();", 10);
                    </script>
                </div>
            </li>
            <li class="layui-nav-item">

            </li>
        </ul>
    </div>


    <aside class="box" id="test">
        <button id="btn" style="background: url(back/images/收回按钮.png)"></button>
    </aside>

    <div class="layui-side layui-bg-black" id="laySide">
        <div class="layui-side-scroll">
            <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
            <ul class="layui-nav layui-nav-tree" lay-filter="test">

                <li class="layui-nav-item layui-nav-itemed">
                    <a href="javascript:;">确认辟谣与起草流言</a>
                    <dl class="layui-nav-child">
                        <dd><a href="tobechecked.html">需辟谣流言</a></dd>
                        <dd><a href="tobedrafted.html">待起草流言</a></dd>
                    </dl>
                    <a href="javascript:;">辟谣管理</a>
                    <dl class="layui-nav-child">

                        <dd><a href="check.html">审核流言</a></dd>
                        <dd><a href="checkedf.html">审核失败流言</a></dd>
                        <dd><a href="checkeds.html">审核成功流言</a></dd>
                    </dl>
                    <a href="javascript:;">平台管理</a>
                    <dl class="layui-nav-child">
                        <dd><a href="distribute.html">账户管理</a></dd>
                    </dl>


                </li>

            </ul>
        </div>
    </div>
    <div class="layui-body" style="height: 660px;" id="layBody">
        <!-- 内容主体区域 -->
        <section>
            <div class="layui-tab layui-tab-brief" lay-filter="demo" lay-allowclose="true">
                <div class="layui-tab-content" style="height: 100px;">
                    <div class="layui-tab-item layui-show">

                        <table class="table display" id="datatable">
                            <thead>
                            <tr>
                                <th>流言ID</th>
                                <th>流言名称</th>
                                <th>流言标签</th>
                                <th>流言详情</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>


<!-- 子页面 -->

<script type="text/template" id="html1">

    <div class="layui-tab layui-tab-brief" lay-filter="demo" lay-allowclose="true">
        <div class="layui-tab-content" style="height: 100px;">
            <div class="layui-tab-item layui-show">
                <h3>&nbsp;&nbsp;起草流言</h3>
                <hr>
                <div class="">

                    <div class="container ">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text">流言ID</span>
                            </div>
                            <input type="text" class="form-control" id="id" name="id" placeholder="流言ID" disabled>
                            <div class="input-group-prepend">
                                <span class="input-group-text">流言名称</span>
                            </div>
                            <input type="text" class="form-control" id="name" name="name" placeholder="流言名称">
                            <div class="input-group-prepend">
                                <span class="input-group-text">流言标签</span>
                            </div>
                            <input type="text" class="form-control" id="label" name="label" placeholder="流言标签">
                            <div class="input-group-prepend">
                                <span class="input-group-text">流言封面</span>
                            </div>
                            <input id="attachment" type="file">
                        </div>
                        <!--<textarea id="ddlSqlArea" placeholder="请输入文章内容..." class="form-control" style="height: 250px;">

                        </textarea>--><br>
                        <div id="editor1">
                            <p>请填写流言详细描述</p>
                        </div>
                        <p>
                            <button class="btn btn-primary btn-lg" style="float:right" role="button" id="draft_btn">提交
                                »
                            </button>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</script>

<script type="text/template" id="html2">
    <br>
    <div id="editor2"></div>
</script>

<script src="back/layui/layui.js"></script>
<script src="back/utils.js"></script>
<script>
    //JavaScript代码区域
    layui.use(['form', 'element', 'laydate'], function () {
        let element = layui.element;
        let form = layui.form;
        form.render();
    });
    let box = document.getElementById("test")
    let btn = document.getElementById("btn")
    let layBody = document.getElementById("layBody")
    let laySide = document.getElementById("laySide")

    let dataSet = [];
    let finalName;

    btn.onclick = function () {
        if (box.offsetLeft === 0) {
            box.style['margin-left'] = -200 + "px"
            layBody.style['margin-left'] = -200 + "px"
            laySide.style['margin-left'] = -200 + "px"
            $("#btn").css('background', 'url(images/放出按钮.png)')
        } else {
            box.style['margin-left'] = 0 + "px"
            layBody.style['margin-left'] = 0 + "px"
            laySide.style['margin-left'] = 0 + "px"
            $("#btn").css('background', 'url(images/收回按钮.png)')
        }
    }

    let html1 = document.getElementById('html1').innerHTML;
    let html2 = document.getElementById('html2').innerHTML;

    function loadTable() {
        let table = $('#datatable').DataTable({
            "searching": false,//是否展示搜索器
            "scrollY": 325,
            "ordering": false,
            "lengthMenu": [10, 20, 30, 50],
            "dom": '<"top">rt<"bottom"lip><"clear">',
            "data": dataSet,
            "language": {
                "infoEmpty": "共0条，",
                "infoFiltered": " - 共_MAX_条，",
                "info": '共 _TOTAL_ 条，',
                "lengthMenu": "显示 _MENU_ 条记录",
                "paginate": {
                    "previous": "<",
                    "next": ">"
                }
            },
            columnDefs: [
                {
                    targets: 0,
                    width: 130,
                    render: function (data, type, row, meta) {
                        return `<div><p>${row.mid}</p></div>`
                    }
                }, {
                    targets: 1,
                    width: 130,
                    render: function (data, type, row, meta) {
                        return `<div><p>${row.messageName}</p></div>`
                    }
                }, {
                    targets: 2,
                    width: 130,
                    render: function (data, type, row, meta) {
                        return `<div><p>${row.tagName}</p></div>`
                    }
                }, {
                    targets: 3,
                    width: 130,
                    render: function (data, type, row, meta) {
                        return `<div><button class="btn mr-5 btn-primary detail" value="${row.description}">查看详情</button></div>`
                    }
                }, {
                    targets: 4,
                    width: 130,
                    render: function (data, type, row, meta) {
                        return `<div><button class="btn mr-5 btn-primary draft" value="${row.mid}">起草辟谣</button></div>`
                    }
                }]
        });
        $(`.detail`).each(function () {
            $(this).click(() => {
                layer.open({
                    type: 1,
                    title: "详情",
                    area: ['500px', '200px'],
                    content: html2
                });
                let E = window.wangEditor;
                editor = new E(`#editor2`);
                editor.customConfig.menus = [];
                editor.create();
                editor.$textElem.attr('contenteditable', false);
                editor.txt.html($(this).val());
            });
        });
        $(`.draft`).each(function () {
            $(this).click(() => {
                layer.open({
                    type: 1,
                    title: "流言详情",
                    area: ['1300px', '720px'], //宽高
                    content: html1,
                });
                fileinput();
                let E = window.wangEditor
                let editor = new E('#editor1')
                editor.create()
                let form = layui.form;
                form.render();
                console.log($(this).val())
                let message;
                for (let i = 0; i < dataSet.length; i++) {
                    let item = dataSet[i];
                    if (item.mid == ($(this).val())) {
                        message = item;
                        break;
                    }
                }
                let mid = message.mid;
                let name = message.messageName;
                let tagName = message.tagName;
                let id_input = $(`#id`);
                let name_input = $(`#name`);
                let label_input = $(`#label`);

                id_input.val(mid);
                name_input.val(name);
                label_input.val(tagName);
                $("#draft_btn").click(function () {
                    let time = new Date();
                    $.ajax({
                        url: '/result/insertResult',
                        type: 'POST',
                        dataType: 'text',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify({
                            "cover": finalName,
                            "description": editor.txt.html(),
                            "mid": mid,
                            "position": message.position,
                            "releaseTime": time,
                            "resultName": name_input.val(),
                            "rid": null,
                            "tagName": label_input.val(),
                            "updateTime": time,
                            "username": Cookies.get('username')
                        }), success: function (result) {
                            window.location.reload();
                        }
                    })
                })
            })
        })
    }

    function fileinput() {
        let attachment = $(`#attachment`);
        attachment.fileinput({
            theme: "fas",
            showUpload: true,
            maxFileCount: 1,
            mainClass: "input-group-lg",
            language: 'zh',
            enctype: 'multipart/form-data',
            uploadAsync: true,
            uploadUrl: 'attachment',
            accept: ["jpg", "jpeg", "png", "bmp", "gif"],
            allowedFileExtensions: ["jpg", "jpeg", "png", "bmp", "gif"],
        }).on('fileuploaded', function(event, data) {
            let response = data.response;
            finalName = response['finalName']
        }).on('fileerror', function(event, data, msg) {
            console.log(event);
            console.log(data);
            console.log(msg);
        })
    }

    function init() {
        $.ajax({
            url: '/message/getAllCheckedMessages',
            type: 'POST',
            dataType: 'json',
            success: function (result, data) {
                dataSet = result;
                // result.forEach(function (item) {
                //     dataSet.push([item.mid, item.messageName, item.tagName, item.description]);
                // });
                loadTable();
            }
        });
    }

    $(function () {
        init();
    })

</script>
<link rel="stylesheet" type="text/css" href="back/首页.css">

</body>
</html>